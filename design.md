# 蓝牙远程开关

## 1. 项目概述

本项目旨在设计一款**电池供电、通过蓝牙控制的小型机械拨动式远程开关**。设备不直接接入市电回路，而是通过电机 + 外部机械结构去“拨动/按压”现有墙壁开关或插座开关，从而实现对原有开关的远程控制。

本方案特点：

- 无需改造市电线路，降低电气安全和施工难度
- 结构上适配常见翘板开关或按键开关
- 采用电池供电，需要重点考虑低功耗设计，保证较长续航
- 通过手机 App 或 PC 蓝牙工具实现控制与状态查看

---

## 2. 使用场景与需求分析

### 2.1 使用场景

- 家里墙壁灯开关改造成“智能开关”，但不想拆墙、不想动市电
- 台灯、电源插座带机械开关的场景，通过外置机械结构去拨动
- 临时场景（租房、宿舍、办公室）中，对原有开关做“外挂式”智能化改造

### 2.2 功能需求

1. **基本功能**
    - 通过蓝牙控制电机驱动机械结构，实现：
        - 翘板开关：向上/向下拨动
        - 按键开关：模拟按下/弹起动作
    - 支持本地按键：
        - 单击：执行一次“切换开关”的机械动作
        - 长按：进入配对/工厂重置模式
    - 提供 LED 状态指示（低功耗前提下尽量减少点亮时间）
2. **蓝牙交互**
    - 支持与手机（Android / iOS）或 PC（带 BLE）的连接
    - 通过自定义 GATT 服务完成“开/关/切换”指令下发
    - 可读取设备电池电量估计值（粗略）与当前逻辑状态
3. **电源与功耗需求**
    - 采用电池供电（例：2×AA / 3×AA / 18650 / 纽扣电池等，具体待选型）
    - 设备在**绝大多数时间处于深度休眠**，仅在以下情况下唤醒：
        - 接收到蓝牙唤醒/连接请求（如支持广告间歇唤醒）
        - 本地按键触发
        - 定时唤醒做电池电量检测（可选）
    - 单次电机动作瞬时电流较大，需要保证电源能承受峰值电流
    - 目标电池寿命：> 6 个月（日常使用频度中等）
4. **机械结构需求（概念级）**
    - 结构可调，适配不同尺寸的墙壁开关
    - 通过夹具/胶粘方式固定在墙壁开关面板上
    - 电机输出端通过连杆/摇臂等结构实现对开关的拨动或按压
    - 机械行程和力度可调（如通过限位结构或软件控制电机转动角度）

---

## 3. 系统总体架构

系统由以下几个部分构成：

- 电池供电与电源管理模块
- 主控 MCU + BLE 模块
- 电机驱动与位置检测模块
- 本地交互模块（按键、低占空比 LED 指示）
- 机械执行机构（连杆/摇臂/齿轮等）
- 上位机端（手机 App / BLE 调试工具）

抽象层次：

1. **硬件层**：电池、电源管理、MCU+BLE、电机与驱动、电机位置检测、按键与 LED
2. **固件层**：低功耗管理、蓝牙协议栈、机械动作控制状态机、参数与电量管理
3. **应用层**：上位机 App 或 BLE 工具，用于配对、控制与简单状态查看

---

## 4. 硬件设计（电池 + 电机方案）

> 此部分为初版方案，具体器件在实现时再细化。
> 

### 4.1 电源与电池方案

- 供电：电池供电，候选方案：
    - 2×AA（3V 左右）+ 升压到 3.3V
    - 18650 锂电池（3.0–4.2V）+ LDO/BUCK 到 3.3V
- 考虑点：
    - 电机峰值电流可能较大，电池需具备足够放电能力
    - 建议电机与 MCU 侧适当做电源隔离或滤波（大电流脉冲不影响 MCU）
    - 加入过放保护（尤其是锂电池）

### 4.2 主控与 BLE 方案（低功耗优先）

**最终选型：Nordic nRF52 系列 MCU**，运行 Zephyr RTOS，应用层业务逻辑使用 Rust 实现。

软件分层约定：

- 底层：nRF52 SoC + Zephyr 驱动（GPIO、PWM、ADC、BLE Controller 等）
- 中间层：Zephyr BLE Host / 蓝牙协议栈 + C/RTOS 层封装
- 应用层：Rust 编写的业务逻辑（通过 FFI 或 Rust-on-Zephyr 的方式与底层交互）

关键需求：

- 支持深度睡眠模式（几 µA 级别），Zephyr 负责电源管理
- 支持定时器/外部中断唤醒（按键、电机位置检测）
- BLE 低功耗广播模式可调节间隔，以平衡“发现速度”和“待机功耗”
- Rust 层只在需要时被唤醒处理事件（如蓝牙指令、电机动作），其余时间由 Zephyr 让系统进入休眠

### 4.3 电机与驱动

1. **电机类型选择**
    - 方案 A：微型**舵机**（如 9g 舵机）
        - 优点：角度控制简单（PWM），行程可控，适合“拨动/按压”动作
        - 缺点：待机时可能仍有一点静态功耗（需完全断电或特殊模式）
    - 方案 B：小型 **直流减速电机 + 机械限位 + 霍尔/光电开关**
        - 优点：结构灵活，扭矩可选
        - 缺点：需要额外限位检测，控制逻辑稍复杂
    - 方案 C：**步进电机/偏心轮结构**
        - 对控制和驱动有一定要求，视开发经验决定
2. **驱动电路**
    - 若使用直流电机：H 桥驱动（如 DRV8833 / L9110S）或简单 N 沟 MOSFET + 单向控制
    - 若使用舵机：通常由一根 PWM 控制线 + 电源，需保证电源足够
    - 建议在 MCU 与电机电源之间加入：
        - 大电容（缓冲启动瞬时电流）
            - 二极管等抑制反电动势
3. **位置/限位检测**（可选但推荐）
    - 通过限位开关/霍尔开关检测“上/下极限位置”
    - 避免电机“硬顶”导致过流和机械损伤

### 4.4 本地交互与指示

- 按键：
    - 1 个用户按键：
        - 短按：触发一次“切换开关”动作
        - 长按：进入配对/恢复出厂模式
    - 按键通过中断唤醒 MCU
- LED：
    - 1 颗多用途 LED，用于：
        - 配对模式指示（闪烁）
        - 操作反馈（动作完成闪一下）
    - 在低功耗设计中，LED 点亮时间必须尽量短，平时保持熄灭

---

## 5. 固件与软件设计

### 5.1 整体软件结构

- 底层驱动：
    - GPIO、PWM（驱动舵机/电机）、定时器
    - 外部中断（按键、限位开关）
    - 睡眠/唤醒控制、电池电压采样（ADC）
- BLE 协议栈：
    - GATT 服务与特征定义
    - 广播参数与连接参数调整（平衡功耗与响应速度）
- 逻辑控制层：
    - 机械动作状态机
    - 逻辑“开关状态”管理
    - 低功耗策略（何时睡眠、何时广播、何时完全关闭电机电源）

### 5.2 BLE 协议设计（低功耗友好）

- 自定义服务：Remote Mechanical Switch Service
- 核心特征：
    1. **Switch Control（开关控制）**
        - 读/写
        - 值：0 = 逻辑关，1 = 逻辑开，2 = TOGGLE（切换）
    2. **Battery Level（电池电量，粗略）**
        - 只读，可仿照标准 Battery Service
    3. **Device Info（可选）**
        - 设备名称、固件版本
    4. **状态上报特征（可选）**
        - 支持 Notify，主动上报当前开关状态变化
- 特征值示例：
    1. **开关控制特征**
        - 属性：读 / 写
        - 值：0 = 关，1 = 开
    2. **设备信息特征**
        - 设备名称、固件版本
- 广播策略示例：
    - 正常待机：低频率广播（如每 1–2 秒），或“间歇性唤醒 + 短时快广播”
    - 配对模式或刚上电调试时：提高广播频率，方便连接

### 5.3 机械动作状态机

逻辑状态示例：

- Idle（空闲）
- MovingToOn（执行“拨到开”动作）
- MovingToOff（执行“拨到关”动作）
- Error（卡住/超时）

流程示例：

1. 收到 BLE 指令或本地按键事件
2. 根据当前逻辑状态（ON/OFF），决定执行哪一套动作：
    - 执行“开”动作：控制电机转到“开”方向，并根据时间/限位信号停止
    - 执行“关”动作：同理
3. 动作完成后：
    - 更新逻辑状态并写入非易失存储（避免频繁写，可以做次数/时间门限）
    - 短暂点亮 LED 作为反馈
    - 回到 Idle 并准备进入休眠

异常处理：

- 若在预期时间内未检测到限位/未完成动作 → 判定为 Error
- Error 状态下可通过 LED 特殊闪烁提示，需要人工调整装置位置

### 5.4 低功耗策略

- 使用深度睡眠模式：
    - 唤醒源：按键中断 / 定时器 / BLE 活动（按芯片能力）
- 广播间隔与连接参数：
    - 非交互期尽量拉长广播间隔
    - 连接时采用合理的 Connection Interval，避免过于频繁的交互
- 外设关断：
    - 电机驱动芯片在非动作时完全关闭（如通过使能脚或 MOSFET 断电）
    - LED 只在有必要时极短时间点亮

---

## 6. 机械结构概要（概念设计）

> 这里先从功能角度描述机械结构，后续可以在单独页面画草图/参数表。
> 
- 固定方式：
    - 夹具结构夹在开关面板两侧
    - 或背胶贴合在面板表面
- 执行机构：
    - 舵机摇臂，通过连杆/直接触压，实现对开关拨杆的上下拨动
    - 或偏心轮结构实现“按压–松开”动作
- 可调能力：
    - 横向、纵向位置可微调，适配不同开关尺寸
    - 摇臂行程可通过软件控制“转动角度”微调

---

## 7. 关键参数与指标（电池机械版，初稿）

- 供电：
    - 电池类型：待定（AA×2 / 18650 等）
    - 目标续航：> 6 个月（每天操作数次、蓝牙偶尔连接）
- 通信：BLE 4.2/5.0
- 电机：
    - 适配常见墙壁开关所需的扭矩
    - 单次动作时间：< 1 秒
- 噪音：
    - 尽量控制在室内可接受范围（舵机/减速电机本身有噪音）

---

## 8. 开发与测试计划（针对电池 + 机械方案）

1. **概念验证阶段**
    - 用开发板 + 舵机 + 简单支架，实现对单个开关的拨动
    - 验证：角度、力度、动作时间
2. **硬件与机械初版**
    - 选定 MCU、BLE、舵机/电机和电池方案
    - 简单 PCB + 3D 打印外壳/支架
3. **固件开发**
    - 实现基础驱动（按键、电机、LED）
    - 接入 BLE 服务，实现开/关/切换
    - 加入低功耗逻辑（睡眠、广播参数、外设关断）
4. **联合调试**
    - 在真实墙壁开关上调试机械位置
    - 调整电机转动角度和限位
    - 测试不同使用频率下的电池寿命（粗略）
5. **优化与迭代**
    - 优化机械结构（稳定性、美观度）
    - 优化固件的唤醒–动作–休眠流程，进一步压低功耗

---

## 9. 后续可扩展方向

- 支持多档位动作（例如拨到中间档的特殊开关）
- 增加陀螺仪/加速度计，用于检测装置是否被误碰/移位
- 结合光照或环境传感器，实现自动开关灯
- 接入 Home Assistant 等智能家居平台，通过网关间接控制 BLE 设备

---

> 本文档为“电池供电 + 电机机械拨动”方案的初版设计说明，后续可以根据你选定的具体芯片、电机型号、机械结构进一步拆分为：电路设计文档、机械结构设计文档、固件架构说明等子文档。
>